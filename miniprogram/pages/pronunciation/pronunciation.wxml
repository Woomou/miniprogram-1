<!-- åŸºäºå‚è€ƒè®¾è®¡çš„ç°ä»£åŒ–æ‹¼è¯»å­¦ä¹ é¡µé¢ -->
<view class="app-container">
  <!-- é¡¶éƒ¨æ¸å˜ AppBar -->
  <view class="app-bar">
    <view class="app-bar-content">
      <view class="app-bar-left">
        <view class="icon-button" bindtap="goBack">
          <text class="icon">â†</text>
        </view>
      </view>
      <view class="app-bar-title">
        <text class="title-text">æ‹¼è¯»ç»ƒä¹ </text>
      </view>
      <view class="app-bar-right"></view>
    </view>
  </view>

  <!-- ä¸»æ»šåŠ¨å®¹å™¨ -->
  <scroll-view class="main-scroll" scroll-y="true">
    
    <!-- å•è¯é€‰æ‹© chips (æ¨ªå‘æ»‘åŠ¨) -->
    <view class="section word-chips-section">
      <scroll-view class="word-chips-scroll" scroll-x="true" show-scrollbar="false">
        <view class="chip-row">
          <view 
            class="word-chip {{selectedWordIndex === index ? 'active' : ''}}" 
            wx:for="{{wordList}}" 
            wx:key="id"
            wx:for-index="index"
            data-index="{{index}}"
            bindtap="selectWordChip"
          >
            <text class="chip-text">{{item.word}}</text>
            <view class="chip-difficulty difficulty-{{item.difficulty}}"></view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- å­¦ä¹ æ­¥éª¤ Tabs -->
    <view class="section tabs-section">
      <view class="step-tabs">
        <view 
          class="tab-item {{activeTab === item.key ? 'active' : ''}} {{item.disabled ? 'disabled' : ''}}" 
          wx:for="{{stepTabs}}" 
          wx:key="key"
          data-key="{{item.key}}"
          bindtap="switchTab"
        >
          <text class="tab-label">{{item.label}}</text>
        </view>
      </view>
    </view>

    <!-- ä¸»è¯å¡ -->
    <view class="section" wx:if="{{currentWord.word}}">
      <view class="main-word-card">
        
        <!-- å•è¯æ ‡é¢˜ -->
        <view class="word-title-section">
          <text class="word-title">{{currentWord.word}}</text>
        </view>

        <!-- ç»„åˆæç¤ºchipsï¼ˆå¦‚æœæ˜¯å¤åˆè¯ï¼‰ -->
        <view class="compose-hints" wx:if="{{wordParts.length > 0}}">
          <view class="hint-chip" wx:for="{{wordParts}}" wx:key="*this">
            <text class="hint-text">{{item}}</text>
          </view>
        </view>

        <!-- éŸ³æ ‡å’Œå‘éŸ³æŒ‰é’® -->
        <view class="ipa-row">
          <text class="phonetic-text">/{{currentWord.phonetic}}/</text>
          <view class="play-button" bindtap="playWordAudio">
            <text class="play-icon">ğŸ”Š</text>
          </view>
        </view>

        <!-- è¯æ€§å’Œè¯ä¹‰ -->
        <view class="meaning-row">
          <text class="word-type">n.</text>
          <text class="word-meaning">{{currentWord.meaning}}</text>
          <text class="detail-link" bindtap="showDetail">è¯¦è§£</text>
        </view>

        <!-- éŸ³ç´ åˆ†æ chips -->
        <view class="phoneme-section">
          <view class="phoneme-chips">
            <view class="phoneme-chip" wx:for="{{phonemeList}}" wx:key="*this">
              <text class="phoneme-text">{{item}}</text>
            </view>
          </view>
        </view>

        <!-- æ‹¼è¯»åŠŸèƒ½æŒ‰é’® -->
        <view class="action-buttons">
          <view 
            class="action-btn {{readingMode === 'phonics' ? 'active' : 'outline'}}" 
            bindtap="switchReadingMode"
            data-mode="phonics"
          >
            <text class="btn-text">è‡ªç„¶æ‹¼è¯»</text>
          </view>
          <view 
            class="action-btn {{readingMode === 'syllable' ? 'active' : 'outline'}}" 
            bindtap="switchReadingMode"
            data-mode="syllable"
          >
            <text class="btn-text">éŸ³èŠ‚æ‹†åˆ†</text>
          </view>
          <view 
            class="action-btn outline" 
            bindtap="goToHandwriting"
          >
            <text class="btn-text">æ‰‹å†™å•è¯</text>
          </view>
        </view>
      </view>
    </view>

    <!-- è¯æ ¹åŠ©è®°å¡ç‰‡ -->
    <view class="section" wx:if="{{currentWord.word && wordParts.length > 0}}">
      <view class="mnemonic-card">
        <view class="mnemonic-badge">
          <text class="badge-text">è¯æ ¹åŠ©è®°</text>
        </view>
        
        <view class="mnemonic-content">
          <view class="word-equation">
            <view class="equation-item" wx:for="{{wordParts}}" wx:key="*this">
              <view class="root-token">
                <text class="root-text">{{item}}</text>
                <text class="root-meaning">{{mnemonicMeanings[item] || ''}}</text>
              </view>
              <text class="equation-operator" wx:if="{{index < wordParts.length - 1}}">+</text>
            </view>
            <text class="equation-operator">=</text>
            <view class="result-token">
              <text class="result-text">{{currentWord.word}}</text>
            </view>
          </view>
          <view class="mnemonic-explanation">
            <text class="explanation-text">{{mnemonicExplanation}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ‹¼è¯»åˆ†æå¡ç‰‡ -->
    <view class="section" wx:if="{{currentWord.word && readingAnalysis}}">
      <view class="analysis-card">
        <view class="analysis-badge">
          <text class="badge-text">{{readingMode === 'phonics' ? 'è‡ªç„¶æ‹¼è¯»åˆ†æ' : 'éŸ³èŠ‚æ‹†åˆ†åˆ†æ'}}</text>
        </view>
        
        <view class="analysis-content">
          <!-- å•è¯æ‹†åˆ†åˆ‡ç‰‡ï¼ˆå¯äº¤äº’çš„æŒ‰é’®åˆ—è¡¨ï¼‰ -->
          <view class="word-parts-section">
            <view class="section-title">
              <text class="title-text">å•è¯æ‹†åˆ†</text>
            </view>
            <view class="word-parts-list">
              <view 
                class="word-part-item interactive" 
                wx:for="{{wordParts}}" 
                wx:key="index"
                wx:for-index="index"
                data-part="{{item}}"
                data-index="{{index}}"
                bindtap="playWordPartAudio"
              >
                <text class="part-text">{{item}}</text>
                <view class="play-icon">ğŸ”Š</view>
              </view>
            </view>
          </view>
          
          <!-- éŸ³ç´ æ‹†åˆ†åˆ‡ç‰‡ï¼ˆåªæ˜¾ç¤ºï¼Œä¸å¯äº¤äº’ï¼‰ -->
          <view class="phoneme-parts-section">
            <view class="section-title">
              <text class="title-text">éŸ³ç´ æ‹†åˆ†</text>
            </view>
            <view class="phoneme-parts-list">
              <view 
                class="phoneme-part-item" 
                wx:for="{{phonemeList}}" 
                wx:key="index"
                wx:for-index="index"
              >
                <text class="phoneme-text">{{item}}</text>
              </view>
            </view>
          </view>
          
          <!-- è‡ªç„¶æ‹¼è¯»æ¨¡å¼ -->
          <view wx:if="{{readingMode === 'phonics'}}">
            <view class="section-title">
              <text class="title-text">ğŸ”¤ è‡ªç„¶æ‹¼è¯»åˆ†æ</text>
              <text class="subtitle-text">å­—æ¯ä¸å‘éŸ³çš„å¯¹åº”å…³ç³»</text>
            </view>
            <view class="phonics-breakdown">
              <view 
                class="phonics-item interactive" 
                wx:for="{{readingAnalysis.phonics}}" 
                wx:key="letters"
                wx:for-index="index"
                data-syllable="{{item.letters}}"
                data-index="{{index}}"
                bindtap="recordSyllable"
              >
                <view class="phonics-content">
                  <text class="letter-part">{{item.letters}}</text>
                  <text class="arrow">â†’</text>
                  <text class="sound-part">{{item.sound}}</text>
                </view>
                <view class="phonics-description" wx:if="{{item.description}}">
                  <text class="desc-text">{{item.description}}</text>
                </view>
                <view class="record-indicator" wx:if="{{recordingSyllableIndex === index}}">ğŸ¤</view>
              </view>
            </view>
            
            <!-- éŸ³èŠ‚å—æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ -->
            <view class="syllable-blocks" wx:if="{{readingAnalysis.syllableBlocks}}">
              <view class="section-title">
                <text class="title-text">ğŸµ éŸ³èŠ‚ç»“æ„</text>
                <text class="subtitle-text">é‡éŸ³å’ŒèŠ‚å¥</text>
              </view>
              <view class="blocks-container">
                <view 
                  class="syllable-block stress-{{item.stress}}"
                  wx:for="{{readingAnalysis.syllableBlocks}}" 
                  wx:key="letters_span"
                >
                  <text class="block-letters">{{item.letters_span}}</text>
                  <text class="block-ipa">{{item.ipa}}</text>
                  <text class="stress-indicator" wx:if="{{item.stress > 0}}">{{item.stress === 1 ? 'Ëˆ' : 'ËŒ'}}</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- éŸ³èŠ‚æ‹†åˆ†æ¨¡å¼ -->
          <view wx:if="{{readingMode === 'syllable'}}">
            <view class="section-title">
              <text class="title-text">ğŸµ éŸ³èŠ‚æ‹†åˆ†åˆ†æ</text>
              <text class="subtitle-text">å•è¯çš„èŠ‚æ‹å’ŒéŸµå¾‹</text>
            </view>
            
            <!-- ARPAéŸ³èŠ‚æ˜¾ç¤º -->
            <view class="syllable-breakdown">
              <view class="breakdown-header">
                <text class="header-text">ARPAéŸ³èŠ‚</text>
              </view>
              <view 
                class="syllable-item arpa interactive" 
                wx:for="{{readingAnalysis.syllables}}" 
                wx:key="index"
                wx:for-index="index"
                data-syllable="{{item}}"
                data-index="{{index}}"
                bindtap="recordSyllable"
              >
                <text class="syllable-text">{{item}}</text>
                <view class="record-indicator" wx:if="{{recordingSyllableIndex === index}}">ğŸ¤</view>
              </view>
            </view>
            
            <!-- IPAéŸ³èŠ‚æ˜¾ç¤º -->
            <view class="ipa-breakdown" wx:if="{{readingAnalysis.ipa}}">
              <view class="breakdown-header">
                <text class="header-text">IPAéŸ³èŠ‚</text>
              </view>
              <view 
                class="syllable-item ipa" 
                wx:for="{{readingAnalysis.ipa}}" 
                wx:key="index"
              >
                <text class="ipa-text">{{item}}</text>
              </view>
            </view>
            
            <!-- é‡éŸ³æ¨¡å¼æ˜¾ç¤º -->
            <view class="stress-breakdown" wx:if="{{readingAnalysis.stressedSyllables}}">
              <view class="breakdown-header">
                <text class="header-text">é‡éŸ³æ ‡è®°</text>
              </view>
              <view class="stress-container">
                <view 
                  class="stress-syllable"
                  wx:for="{{readingAnalysis.stressedSyllables}}" 
                  wx:key="index"
                >
                  <view 
                    class="stress-phoneme level-{{phoneme.level}}"
                    wx:for="{{item}}"
                    wx:for-item="phoneme"
                    wx:key="sub"
                  >
                    <text class="phoneme-text">{{phoneme.sub}}</text>
                    <text class="stress-mark" wx:if="{{phoneme.level === 1}}">Ëˆ</text>
                    <text class="stress-mark" wx:if="{{phoneme.level === 2}}">ËŒ</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <view class="analysis-tips">
          <text class="tips-text">{{readingAnalysis.tips}}</text>
        </view>
      </view>
    </view>

    <!-- å½•éŸ³æµ‹è¯•å¡ç‰‡ -->
    <view class="section" wx:if="{{currentWord.word && activeTab === 'read'}}">
      <view class="recording-card">
        <view class="recording-badge">
          <text class="badge-text">å‘éŸ³æµ‹è¯•</text>
        </view>
        
        <!-- å½•éŸ³æŒ‰é’® -->
        <view class="recording-section">
          <view class="microphone-container">
            <view 
              class="microphone-btn {{isRecording ? 'recording' : ''}}" 
              bindtap="toggleRecording"
            >
              <view class="mic-icon">
                <text class="mic-text">{{isRecording ? 'â¹' : 'ğŸ¤'}}</text>
              </view>
              <text class="mic-label">{{isRecording ? 'å½•éŸ³ä¸­...' : 'ç‚¹å‡»å½•éŸ³'}}</text>
            </view>
          </view>
        </view>

        <!-- å½•éŸ³ç»“æœåˆ†æ -->
        <view class="result-analysis" wx:if="{{recognitionResult}}">
          <view class="result-title">
            <text class="title-text">è¯†åˆ«åˆ†æ</text>
          </view>
          
          <view class="word-comparison">
            <view class="comparison-item original">
              <text class="item-label">ç›®æ ‡å•è¯</text>
              <text class="item-word">{{currentWord.word}}</text>
            </view>
            <view class="comparison-arrow">
              <text class="arrow-text">â†’</text>
            </view>
            <view class="comparison-item recognized">
              <text class="item-label">è¯†åˆ«ç»“æœ</text>
              <text class="item-word">{{recognitionResult}}</text>
            </view>
          </view>

          <!-- å‡†ç¡®åº¦æ˜¾ç¤º -->
          <view class="accuracy-display">
            <view class="accuracy-bar-container">
              <view class="accuracy-bar">
                <view class="accuracy-fill" style="width: {{accuracyScore}}%"></view>
              </view>
            </view>
            <text class="accuracy-score">{{accuracyScore}}%</text>
          </view>

          <!-- å‘éŸ³åé¦ˆ -->
          <view class="feedback-section" wx:if="{{feedback}}">
            <text class="feedback-title">æ”¹è¿›å»ºè®®</text>
            <text class="feedback-content">{{feedback}}</text>
          </view>

          <!-- é‡è¯•æŒ‰é’® -->
          <view class="retry-section">
            <view class="retry-btn" bindtap="retryTest">
              <text class="retry-text">é‡æ–°æµ‹è¯•</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å®ç”¨å£è¯­å¡ç‰‡ -->
    <view class="section" wx:if="{{currentWord.word && usageExample}}">
      <view class="usage-card">
        <view class="usage-badge">
          <text class="badge-text">å®ç”¨å£è¯­</text>
        </view>
        <view class="usage-content">
          <rich-text class="usage-text" nodes="{{usageExample}}"></rich-text>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!currentWord.word}}">
      <text class="empty-text">é€‰æ‹©ä¸€ä¸ªå•è¯å¼€å§‹å­¦ä¹ </text>
    </view>

    <!-- åº•éƒ¨é—´è· -->
    <view class="bottom-spacing"></view>
  </scroll-view>
</view> 
